<!-- Табличка с поступлениями -->

<% if @timesheet_dates.present? %>

  <% date_ve = @timesheet.date_ve %>
  <% date_vb = @timesheet.date_vb %>
  <% date_ee = @timesheet.date_ee %>
  <% date_eb = @timesheet.date_eb %>
  <% count_days = date_ee.day - date_eb.day + 1 %>

  <%= content_tag :table, class: :table, data: { param_name: :reasons_absence_id,
        path_update: "#{ institution_timesheets_dates_update_path }?id=" } do %>

    <% for i in 0..count_days do %>
      <%= content_tag :col %>
    <% end %>

    <%= content_tag :thead do %>
      <%= content_tag :tr do %>
        <%= content_tag :th, 'Дитина' %>
        <% ( date_eb..date_ee ).each do | v | %>
          <%= content_tag :th, "#{ v.day } #{ short_day_of_week( v.wday ) }" %>
        <% end %>
      <% end %>
    <% end %>

    <%= content_tag :tbody do %>
      <% children_category_id = 0 %>
      <% children_group_id = 0 %>

      <% @timesheet_dates.group_by{ | o | [ o.children_category_id, o.children_group_id, o.child_id ] }
           .each do | k, v | %>

             <% if children_category_id != k[ 0 ] %>
               <% children_category_id = k[ 0 ] %>
               <% children_group_id = 0 %>

               <%= content_tag :tr, class: [ :row_group, :category_name ] do %>
                 <%= content_tag( :td, v[ 0 ].category_name ) %>
                 <%= content_tag( :td, '', colspan: count_days ) %>
               <% end %>
             <% end %>

             <% if children_group_id != k[ 1 ] %>
               <% children_group_id = k[ 1 ] %>

               <%= content_tag :tr, class: [ :row_group, :group_name ] do %>
                 <%= content_tag( :td, v[ 0 ].group_name ) %>
                 <%= content_tag( :td, '', colspan: count_days ) %>
               <% end %>
             <% end %>

             <%= content_tag :tr do %>
               <%= content_tag :td, v[ 0 ].child_name %>
                 <% index = 0  %>
                 <% ( date_eb..date_ee ).each do | v1 | %>
                   <% if index < v.size && v[ index ].date == v1 %>
                     <% v2 = v[ index ]  %>
                       <%= content_tag :td, v2.mark,
                         disabled: @timesheet.date_sa || ( v2.mark.blank? && !v2.reason_code.blank? ),
                         data: { id: v2.id, reasons_absence_id: v2.reasons_absence_id }, class: :tb_mark %>
                     <% index = index + 1 %>
                   <% else %>
                     <%= content_tag :td, '.'  %>
                   <% end %>
                 <% end %>


             <% end %>
           <% end %>

    <% end %>
  <% end %>

<% end %>