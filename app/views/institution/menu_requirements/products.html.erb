<!-- Отображение документа меню-требования -->

<% date_sap = @menu_requirement.date_sap %>
<% date_saf = @menu_requirement.date_saf %>
<% children_categories_array = [] %>

<%= content_tag :main, id: :menu_requirement_products do %>

  <%= content_tag :h1, "Меню-вимога № #{ @menu_requirement.number } від #{ date_str( @menu_requirement.date ) }",
      data: { text: "Меню-вимога № #{ @menu_requirement.number } від" }, class: :icon_hide %>

  <%= content_tag :div, id: :panel_main do %>
    <%= content_tag :div, class: :panel do %>
      <%= button_tag ' план', class: :btn_send, id: :send_sap, disabled: date_sap || date_saf,
                     data: { ajax_path: "#{ institution_menu_requirements_send_sap_path }?id=#{ @menu_requirement.id }" } %>
      <%= button_tag ' факт', class: :btn_send, id: :send_saf, disabled: !date_sap || date_saf,
                     data: { ajax_path: "#{ institution_menu_requirements_send_saf_path }?id=#{ @menu_requirement.id }" } %>
      <%= button_tag '', class: (date_saf ? :btn_exit : :btn_save),
                     onclick: "location.href='#{ institution_menu_requirements_index_path }'" %>

      <% if date_sap %>
        <%= label_tag '', 'Надіслано план:' %>
        <%= label_tag :number, 'документ' %>
        <%= content_tag :nav, class: :icon_number do %>
          <%= text_field_tag :number_sap, @menu_requirement.number_sap, disabled: true %>
        <% end %>

        <%= label_tag :date, 'від' %>
        <%= content_tag :nav, class: :icon_сalendar do %>
          <%= text_field_tag :date, date_str(date_sap), disabled: true %>
        <% end %>
      <% end %>

      <% if date_saf %>

        <%= label_tag '', 'факт:' %>
        <%= label_tag :number, 'документ' %>
        <%= content_tag :nav, class: :icon_number do %>
          <%= text_field_tag :number_saf, @menu_requirement.number_saf, disabled: true %>
        <% end %>

        <%= label_tag :date, 'від' %>
        <%= content_tag :nav, class: :icon_сalendar do %>
          <%= text_field_tag :date, date_str(date_saf), disabled: true %>
        <% end %>
      <% end %>
    <% end %>

    <%= content_tag :div, class: :panel do %>
      <%= label_tag :number, 'Меню-вимога' %>
      <%= content_tag :nav, class: :icon_number do %>
        <%= text_field_tag :number, @menu_requirement.number, disabled: true %>
      <% end %>

      <%= label_tag :date, 'від' %>
      <%= content_tag :nav, class: :icon_сalendar do %>
        <%= text_field_tag :date, date_str(@menu_requirement.date), disabled: date_sap, readonly: true, data: {
          ajax_path: "#{ institution_menu_requirements_update_path }?id=#{ @menu_requirement.id }" } %>
      <% end %>

      <%= label_tag :splendingdate, 'Дата списання' %>
      <%= content_tag :nav, class: :icon_сalendar do %>
        <%= text_field_tag :splendingdate, date_str( @menu_requirement.splendingdate ), disabled: date_saf, readonly: true  %>
      <% end %>
    <% end %>
  <% end %>

  <% if @menu_children_categories %>
    <%= content_tag :h2, "Кількість дітей по категоріях", class: :icon_hide %>

    <%= content_tag :div, id: :table_menu_children_categories do %>
      <%= content_tag :table, class: :table  do %>

        <% for i in 1..10 do %>
          <%= content_tag :col %>
        <% end %>

        <%= content_tag :thead do %>
          <%= content_tag :tr do %>
            <%= content_tag :th, 'Категорії', rowspan: 3 %>
            <%= content_tag :th, 'Кількість дітей', colspan: 4 %>
            <%= content_tag :th, 'Вартість дітодня', colspan: 5 %>
          <% end %>

          <%= content_tag :tr do %>
            <%= content_tag :th, 'План', colspan: 2 %>
            <%= content_tag :th, 'Факт', colspan: 2 %>
            <%= content_tag :th, 'За постановою', rowspan: 2 %>
            <%= content_tag :th, 'План', colspan: 2 %>
            <%= content_tag :th, 'Факт', colspan: 2 %>
          <% end %>

          <%= content_tag :tr do %>
            <% ['Всього', 'Пільговики', 'Всього', 'Пільговики', 'Вартість', 'Відхилення', 'Вартість', 'Відхилення'].each do |value|  %>
              <%= content_tag :th, value %>
            <% end %>
          <% end %>

        <% end %>

        <%= content_tag :tbody do %>
          <% @menu_children_categories.each_with_index do |menu_children_category, index| %>
            <% children_categories_array << {id: menu_children_category.children_category_id, name: menu_children_category.name} %>
            <%= content_tag :tr do %>

              <%= content_tag :td, menu_children_category.name %>
              <% [:plan, :fact].each do |value1| %>
                <% [:count_all, :count_exemption].each do |value2| %>
                  <%= content_tag :td do %>
                    <% if (!date_sap && value1 == :plan ) || (date_sap && !date_saf && value1 == :fact ) %>
                      <%= text_field_tag "#{value2}_#{value1}_#{menu_children_category.children_category_id}", menu_children_category["#{value2}_#{value1}"].nonzero?,
                        data: { ajax_path: "#{ institution_menu_requirements_children_category_update_path }?id=
                            #{ menu_children_category.id }" } %>
                    <% else %>
                      <%= menu_children_category[ "#{ value2 }_#{ value1 }"].nonzero? %>
                    <% end %>
                  <% end %>

                <% end %>
              <% end %>

              <%= content_tag :td, f2_to_s(menu_children_category.cost), id: "cost_#{menu_children_category.children_category_id}" %>

              <% [:plan, :fact].each do |value| %>
                <% sum = @menu_products.sum{ |o| o["sum_#{value}_#{index}"].to_f }.round(2) %>
                <% menu_children_category_count = menu_children_category["count_all_#{value}"] - menu_children_category["count_exemption_#{value}"] %>
                <% children_cost = (menu_children_category_count.zero? ? 0 : sum / menu_children_category_count ).round(2) %>
                <% children_diff = children_cost - menu_children_category.cost.to_f %>
                <%= content_tag :td, f2_to_s(children_cost), data: { sum: sum.nonzero? }, id: "children_cost_#{value}_#{menu_children_category.children_category_id}" %>
                <%= content_tag :td, f2_to_s(children_diff), id: "children_diff_#{value}_#{menu_children_category.children_category_id}", class: (children_diff.positive? ? :positive : :negative) %>
              <% end %>

            <% end %>
          <% end %>
        <% end %>

        <%= content_tag :tfoot do %>
          <%= content_tag :td, 'Всього:' %>
          <% [:plan, :fact].each do |value1| %>
            <% [:count_all, :count_exemption].each do |value2| %>
              <%= content_tag :td, @menu_children_categories.sum{ |o| o["#{value2}_#{value1}"] }.nonzero?, id: "#{value2}_#{value1}_total" %>
            <% end %>
          <% end %>

          <% for i in 1..5 do %>
            <%= content_tag :td %>
          <% end %>
        <% end %>

      <% end %>
    <% end %>
  <% end %>

  <% if @menu_products %>
    <% categories_count = children_categories_array.size %>

    <%= content_tag :h2, 'Продукти харчування', class: :text_block %>

    <%= content_tag :div, id: :table_menu_products, class: :min_height do %>
      <%= content_tag :table, class: :table do %>

        <% for i in 1..categories_count * 3 + 4 do %>
          <%= content_tag :col %>
        <% end %>

        <%= content_tag :thead do %>

          <%= content_tag :tr do %>
            <%= content_tag :th, 'Продукти харчування', rowspan: 3 %>
            <%= content_tag :th, 'Ціна', rowspan: 3 %>
            <% {plan: 'План', fact: 'Факт'}.each do |key, value| %>
              <%= content_tag :th, value, colspan: (categories_count * (key == :fact ? 2 : 1) + 1) %>
            <% end %>
          <% end %>

          <%= content_tag :tr do %>
            <% [:plan, :fact].each do |value| %>
              <% children_categories_array.each_with_index do |children_category, index| %>
                <%= content_tag :th, children_category[:name], (value == :plan ? { rowspan: 2 } : { colspan: 2 } )  %>
              <% end %>
              <%= content_tag :th, 'Всього', class: :sum_col, rowspan: 2 %>
            <% end %>
          <% end %>

          <%= content_tag :tr do %>
             <% for i in 1..categories_count do %>
              <% ["відх.", "к-сть"].each do |value|  %>
                <%= content_tag :th, value %>
              <% end %>
            <% end %>
          <% end %>

        <% end %>

        <%= content_tag :tbody do %>
          <% @menu_products.each do |menu_product| %>
            <%= content_tag :tr do %>
              <%= content_tag :td, menu_product.name %>
              <%= content_tag :td, f3_to_s(menu_product.price), id: "price_#{menu_product.product_id}" %>

              <% [:plan, :fact].each do |value1|  %>
                <% children_categories_array.each_with_index do |children_category, index| %>
                  <% menu_product_id = menu_product["id_#{index}"]  %>
                  <% (value1 == :plan ? [:plan] : [:diff, :fact]).each do |value2| %>

                    <%= content_tag :td do %>
                      <% if menu_product_id  %>
                        <% count_value = menu_product["count_#{value2}_#{index}"] %>
                        <% if (!date_sap && value1 == :plan) || (date_sap && !date_saf && value1 == :fact) %>
                          <%= text_field_tag "count_#{value2}_#{menu_product.product_id}_#{children_category[:id]}_#{menu_product_id}", f3_to_s(count_value),
                            class: ((count_value.positive? ? :positive : :negative) if value2 == :diff),
                            data: ( { sum: menu_product["sum_#{value1}_#{index}"], ajax_path: "#{menu_requirements_product_update_path}?id=#{menu_product_id}" } unless value2 == :diff ) %>
                        <% else %>
                          <%= f3_to_s(count_value) %>
                        <% end %>
                      <% end %>
                    <% end %>

                  <% end %>
                <% end %>
                <%= content_tag :td, (f3_to_s( menu_product["count_#{value1}_all"]) unless value1 == :fact && !date_sap  ), id: "count_#{value1}_all_#{menu_product.product_id}" %>
              <% end %>
            <% end %>
          <% end %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>

<% end %>









